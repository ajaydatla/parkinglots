<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tickets</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #fafafa;
        }
        h2 {
            text-align: center;
            margin: 20px 0;
            color: #2c3e50;
        }
        table {
            border-collapse: collapse;
            margin: 20px auto;
            width: 80%;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px 14px;
            text-align: center;
        }
        th {
            background-color: #f4f6f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
    </style>
</head>
<body>
<h2>Parking Tickets</h2>
<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Ticket Number</th>
        <th>Plate Number</th>
        <th>Slot Number</th>
        <th>Entry Time</th>
        <th>Exit Time</th>
        <th>Status</th>
        <th>Amount</th>
        <th>Action</th>
        <th>User</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="ticket : ${tickets}">
        <td th:text="${ticket.id}"></td>
        <td th:text="${ticket.ticketNumber}"></td>
        <td th:text="${ticket.plateNumber}"></td>
        <td th:text="${ticket.slotNumber}"></td>
        <td th:text="${#temporals.format(ticket.entryTime, 'yyyy-MM-dd HH:mm')}"></td>
        <td th:text="${ticket.exitTime != null ? #temporals.format(ticket.exitTime, 'yyyy-MM-dd HH:mm') : 'N/A'}"></td>
        <td th:text="${ticket.status}"></td>
        <td th:text="${ticket.amount}"></td>
        <td>
            <!-- compare using the enum constant to be safe -->
            <button type="button"
                    th:if="${ticket.status == T(com.parkinglot.enums.TicketStatus).ACTIVE}"
                    th:attr="data-ticket=${ticket.ticketNumber}"
                    class="btn-exit">
                Exit Now
            </button>

            <span th:if="${ticket.status != T(com.parkinglot.enums.TicketStatus).ACTIVE}">
          Exited
        </span>
        </td>
        <td th:text="${ticket.user}"></td>

    </tr>
    </tbody>
</table>

</body>
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('click', function (e) {
      if (e.target && e.target.classList.contains('btn-exit')) {
        const ticketNumber = e.target.getAttribute('data-ticket');
        exitVehicle(ticketNumber);
      }
    });

    async function exitVehicle(ticketNumber) {
      if (!ticketNumber) return;
      if (!confirm('Exit vehicle with ticket ' + ticketNumber + '?')) return;

      const body = { ticketNumber: ticketNumber };

      try {
        const resp = await fetch('/api/parking/payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
          credentials: 'same-origin'
        });

        const json = await resp.json();

        if (resp.ok && json.success) {
          alert('Exit successful. Fee: ' + (json.data?.fee ?? 'N/A'));
          window.location.reload();
        } else {
          alert('Error: ' + (json.message || JSON.stringify(json)));
        }
      } catch (err) {
        console.error(err);
        alert('Request failed. See console for details.');
      }
    }
    /*]]>*/
</script>

</html>
